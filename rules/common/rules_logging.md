# rules_logging.md - ログ・観測・調査記録ルール

**作成日**: 2025-12-11  
**最終更新**: 2025-12-11  
**バージョン**: 1.0  
**目的**: ログと調査記録の扱いを統一し、トラブルシュートと監査性を高める  
**適用範囲**: ログ出力／調査メモ／監査ログを扱うすべてのプロジェクト

---

## 1. 基本方針

- ログは「後から原因を再現できるだけの情報を残す」ことを目的とする
- 調査記録は「何を、どう調べて、何が分かったか」を再現できる形で残す
- ログと記録は、**機密情報を含まない形** で構造的に保存する

---

## 2. 調査記録（docs/調査/）

### 2.1 保存場所と命名規則

調査依頼や不具合分析を行った場合、結果は必ず次の場所に保存する：

```text
docs/調査/
  YYYYMMDD_hhmmss_説明的なタイトル.md
```

- `YYYYMMDD`: 調査開始日（JST）
- `hhmmss`: 調査開始時刻（JST）
- `説明的なタイトル`: 内容が分かる短い日本語

例：

- `20251209_143052_ブラウザ起動エラー調査.md`
- `20251209_150000_外部APIタイムアウト調査.md`

### 2.2 記載項目

調査記録には、最低限次を含める：

1. 概要（何の調査か）
2. 発生状況（いつ・どこで・どの条件で）
3. 調査手順（何をどの順で試したか）
4. 発見事項（分かった事実のみ）
5. 結論・対策（根本原因と今後の対応）
6. 関連ファイル（ソースパス・ログパス等）

---

## 3. ログディレクトリ（logs/）

### 3.1 保存場所と構造

すべてのログは、原則としてリポジトリ直下またはプロジェクト直下の `logs/` に保存する：

```text
logs/
  YYYYMMDD_hhmmss_説明的なフォルダ名/
    error.log
    debug.log
    access.log
    summary.md
```

例：

- `20251209_143052_エラーログ分析/`
- `20251209_150000_パフォーマンス測定/`

### 3.2 Git 管理との関係

- `logs/` 以下は `.gitignore` により Git 管理から除外する
- ログは再生成可能な一時情報として扱う

```gitignore
logs/
*.log
/log/
```

---

## 4. 非破壊ログ原則

### 4.1 原則

- 既存システムに対するログ追加は「非破壊的」に行う
- ログ追加により、処理の意味的挙動を変えない
- ログ出力によるレスポンス遅延を最小限に抑える

### 4.2 実装のポイント

- 可能なら非同期バッファ経由でログを吐く
- 高頻度イベントはサンプリングする（ただし監査ログは除外）
- ログフォーマットにバージョン（スキーマバージョン）を持たせる

---

## 5. 重要ログのサンプリング除外

次の 8 種類のタグを持つログは、発生頻度に関わらず **すべて記録する**：

1. `audit`          - 監査ログ（認証、権限変更など）
2. `state_change`   - 重要な状態変化（ステータス遷移等）
3. `external`       - 外部依存（API、DB、ファイル I/O、システムコール）
4. `business_logic` - ビジネスロジック上重要な判断
5. `error`          - エラー
6. `exception`      - 例外
7. `startup`        - 起動時のログ（設定やバージョン等）
8. `config`         - 設定値の記録（起動時スナップショットなど）

実装上は、ログ関数やラッパーを用意し、タグを明示的に指定する。

---

## 6. 重複ログの防止

### 6.1 原則

- 同一イベントを、複数のレイヤーで重複記録しない
- 特に、デバッグ用ログと本番用ログの役割を分離する

### 6.2 注意点

- デバッグログに、監査や集計のキーとして解釈される情報
  （例: `state_key`, `external_operation` など）を含めない
- 共通ログ関数（例: `logStateChange()`, `logExternalAPICall()`）を使う場合、
  追加の手書きログが不要かどうかを確認する
- ログ設計時に、「どこで何を 1 回だけ記録するか」を決めておく

---

## 7. 機密情報のマスキング

### 7.1 機密情報として扱うもの

ログにそのまま出してはいけない代表例：

- 認証情報: `password`, `pass`, `pwd`, `passwd`
- トークン: `token`, `access_token`, `id_token`, `refresh_token`, `api_key`
- 秘密鍵: `private_key`, `secret`, `secret_key`, `private_key_id`
- 個人識別子: `ssn`, `passport`, `person_id` など（要件に応じて）
- クレジットカード番号や CVV 等

### 7.2 マスキング関数の実装例（Python）

```python
import re

TOKEN_PATTERN = re.compile(
    r'(?i)(token|access_token|id_token|refresh_token)\s*[:=]\s*([A-Za-z0-9\-_.]+)'
)

PASSWORD_PATTERN = re.compile(
    r'(?i)(password|passwd|pwd)\s*[:=]\s*([^\s&]+)'
)

CREDIT_CARD_PATTERN = re.compile(r'\b\d{13,16}\b')


def mask_sensitive_text(text: str) -> str:
    text = TOKEN_PATTERN.sub(r'\1=***MASKED***', text)
    text = PASSWORD_PATTERN.sub(r'\1=***MASKED***', text)
    text = CREDIT_CARD_PATTERN.sub('****-****-****-****', text)
    return text
```

構造化データ（dict 等）の場合は、キー名に応じて再帰的にマスクする。

---

## 8. ログレベルと出力方針

- `DEBUG`: 詳細な動作確認用。開発時のみ有効にする
- `INFO`: 通常の動作（開始・終了・状態変化）
- `WARNING`: 想定内だが注意が必要な状況
- `ERROR`: 処理が完了できなかったエラー
- `CRITICAL`: システム継続が危険なレベルの障害

- 本番環境では、`INFO` 以上を基本とし、必要に応じて `DEBUG` を一時的に有効化する

---

## 9. プロジェクト固有ルール

- ログの出力先（ファイル、標準出力、集中ログ基盤等）
- ログフォーマット（JSON / テキスト）
- 保管期間やローテーションポリシー
- 個人情報・機微情報の扱い

これらは各プロジェクトの `PROJECT_AGENT.md` または `rules_domain.md` にて上書き・詳細化する。
